---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(tidymodels)
```

```{r}
# Get the Data
volcano <- read.csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')

```

#### Exploracion de los datos

Variable de salida: Tipo de Volcan: primary_volcano_type

```{r}
volcano %>% mutate(primary_volcano_type = as.factor(primary_volcano_type)) %>% select(primary_volcano_type) %>% summary()
#No te da todo el detalle
```

```{r}
volcano %>% count(primary_volcano_type,sort = TRUE)
```

Limpieza de variable de salida

```{r}
df <- volcano %>% transmute(
  volcano_number,
 type = case_when(
   str_detect(primary_volcano_type,"Stratovolcano")~"Stratovolcano",
   str_detect(primary_volcano_type,"Shield")~"Shield",
TRUE ~"Other"),
latitude, longitude, elevation, major_rock_1, tectonic_settings) %>% 
  mutate_if(is.character, factor)
```

```{r}
head(df)
```

```{r}
df %>% count(type, sort = TRUE)
```

## Visualización en un mapa por tipo de volcan

```{r}
world <- map_data('world')
# Longitudes y latitudes por grupo 
head(world)
```

```{r}
ggplot() + 
  geom_map(
    data = world, map = world, aes(long, lat, map_id = region),
    color = 'white', fill = 'gray40', size = 0.05, alpha = 0.2
  ) + geom_point(data = df, aes(longitude, latitude, color = type), 
                 alpha = 0.8 # Transparencia del puntito.
                 )
```

```{r}
# TODO terminar exploración de datos
```

## Modelo

### Aplicación de bootstrap

Crear datos simulados similares a los que ya se tienen, lo ideal es usar siempre nuestros datos, pero esta es una alternativa para poder generar nuevos datos.

Entonces bootstrap crea datos simulados con la misma distribución. Hay que tener cuidado por aquello de las fugas.

rsample (tidymodels) viene de tidymodels, en este caso crea 25 subconjuntos

```{r}
data_boots <- bootstraps(df)
```

```{r}
library(themis)
```

Receta (Preprocesado de datos)

```{r}
recipe_data <- recipe(
  type ~ .,
  data = df) %>% 
  update_role(volcano_number, new_role = 'id') %>% # Para identificar id
  step_other(major_rock_1) %>% # Variables categoricas en step_other
  step_other(tectonic_settings) %>% # Variables categoricas en step_other
  step_dummy(major_rock_1, tectonic_settings) %>% # Categoricas a dummy
  step_zv(all_predictors()) %>% # Verifica que no haya varianza 0
  step_normalize(all_predictors()) %>% # Hace normalización y centralización
  step_smote(type) # Especifica la variable de salida
  
  
```

### Preparación de la receta

```{r}
data_prep <- prep(recipe_data)
juice(data_prep) # mostrar la preparación
```

## Crear el modelo

```{r}
tree_model <- decision_tree() %>% 
  set_mode('classification') %>% 
  set_engine('rpart')
```

### Workflow

```{r}
volcano_wf <- workflow() %>% 
  add_recipe(recipe_data) %>% 
  add_model(tree_model)

volcano_wf
```

Fit o entrenamiento del modelo

```{r}
fit_model <- fit_resamples(
  volcano_wf,
  resamples = data_boots,
  control = control_resamples(save_pred = TRUE)
  
)
fit_model
```

```{r}
fit_model %>% collect_metrics()
```

### Matriz de confusión 3x3 (3 clases)

```{r}
fit_model %>% collect_predictions() %>% conf_mat(type, .pred_class)
```

### Importancia de los predictores

```{r}
library(vip)
tree_model %>% set_engine('rpart', importance = 'permutation') %>% 
  fit(
    type ~.,
    data = juice(data_prep) %>% 
      select(~volcano_number) %>% 
      janitor::clean_names()
  ) %>% 
  vip(geom = 'point')
```
